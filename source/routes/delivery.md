# 7. Работа с заказами

## 1. Создание заказа доставки

> Пример запроса

```python
# TODO
```

### HTTP запрос

`GET https://{account_name}.caffesta.com/a/v1.0/draft/storages`

Передача заказа доставки из Вашего приложения в Caffesta происходит при обращении по пути
`/a/v1.0/draft/storages` c использованием метода **POST** и передачей в теле запроса JSON-объекта следующей структуры:

```json
{
  "bill": {
    "pos_id": 2,
    "app_id": 26,
    "delivery_type": 2,
    "total_sum": 6.83,
    "payments": [
      {
        "payment_id": 2,
        "value": 6.83
      }
    ],
    "items": [
      {
        "title": "Имя товара",
        "count": 1,
        "price": 5.5,
        "discount_sum": 1.37,
        "origin_price": 5.5,
        "total_sum": 4.13,
        "product_id": 3,
        "data": null
      }
    ],
    "client": {
      "uuid": "569224f7-8f91-4142-9a7e-85a3bc24bbd9",
      "name": "Иван",
      "last_name": "Иванов",
      "address": "Адрес Ивана Иванова",
      "birthday": "2000-12-21",
      "phone": "+375292222222",
      "email": "ivan@ivanov.iv",
      "card_number": "111222333444",
      "discount_group": {
        "id": 1
      }
    },
    "created_at": "2021-12-21T20:25:00",
    "started_at": "2021-12-25T23:55:00",
    "comment": "order comment",
    "delivery": {
      "address": "addr"
    }
  }
}
```

<aside class="warning">
Все суммы и скидки должны рассчитываться на стороне интегрируемого сервиса или программы.
Передача отрицательных значений для количеств, сумм, скидок и итогов по заказу недопустима.

</aside>

<aside class="notice">
Если нужно передать количество товара меньше литра или килограмма, то можно использовать вещественное число, например <b>0.8</b>
</aside>

| Название       |       Тип       |         Обязателен         | Описание                                                                                                                                   |
|----------------|:---------------:|:--------------------------:|--------------------------------------------------------------------------------------------------------------------------------------------|
| bill           |     object      |             да             | Данные по передаваемому заказу                                                                                                             |
| pos_id         |       int       |            нет             | ID точки продаж<br/>(если указан, то заказ автоматически отправится на точку продаж; если отсутствует, то заказ "зависнет" в админпанели)  |
| app_id         |       int       |             да             | Номер заказа (если указать `-1`, то нумерация заказу будет присваиваться на точке продаж)                                                  |
| delivery_type  |       int       |             да             | Тип заказа (`0 — на месте, 1 — самовывоз, 2 — доставка`)                                                                                   |
| total_sum      |      float      |             да             | Итоговая сумма заказа                                                                                                                      |
| payments       | object или null |            нет             | Список типов оплат, которыми оплачен заказ<br/>(если поле отсутствует либо как значение указано **null**, то заказ считается неоплаченным) |
| payment_id     |       int       |             да             | ID типа оплаты (`1 — наличные,  2 — карта`)                                                                                                |
| value          |      float      |             да             | Сумма к оплате                                                                                                                             |
| items          |     object      |             да             | Список товаров в заказе                                                                                                                    |
| title          |     string      |             ?              | Наименование товара.<br/>Заменяет название товара только для этого заказа                                                                  |
| count          |      float      |             да             | Количество товара (`в штуках, литрах или килограммах`)                                                                                     |
| price          |      float      |             ?              | Цена за единицу измерения товара (`1 штуку, 1 килограмм или 1 литр`) с учётом модификаторов                                                |
| discount_sum   |      float      |             ?              | Сумма скидки на товар                                                                                                                      |
| origin_price   |      float      |             ?              | Цена за единицу измерения товара (`1 штуку, 1 килограмм или 1 литр`) без учёта модификаторов                                               |
| total_sum      |      float      |             да             | ИТОГО по позиции                                                                                                                           |
| product_id     |       int       |             да             | ID товара в Каффесте                                                                                                                       |
| data           | object или null |            нет             | Не используется                                                                                                                            |
| client         | object или null |                            | Информация по клиенту, для которого заказ.<br/>Если клиент не указан, то заказ **НЕ БУДЕТ** отправлен на точку продаж                      |
| uuid           |     string      |            нет             | UUID клиента в Caffesta (если указан, то к заказу будет привязан **уже существующий** в базе Caffesta клиент)                              |
| name           |     string      | да<br/>если не указан UUID | Имя клиента                                                                                                                                |
| last_name      |     string      | да<br/>если не указан UUID | Фамилия клиента                                                                                                                            |
| address        |     string      | да<br/>если не указан UUID | Адрес проживания/доставки                                                                                                                  |
| birthday       |     string      |            нет             | День рождения клиента                                                                                                                      |
| phone          |     string      | да<br/>если не указан UUID | Номер телефона                                                                                                                             |
| email          |     string      |            нет             | Электронная почта                                                                                                                          |
| card_number    |     string      | да<br/>если не указан UUID | № карты лояльности                                                                                                                         |
| discount_group |     object      | да<br/>если не указан UUID |                                                                                                                                            |
| id             |       int       | да<br/>если не указан UUID | ID скидочной группы клиента                                                                                                                |
| created_at     |     string      |             да             | Время создания заказа (`указывается в UTC+0`)                                                                                              |
| started_at     |     string      |             да             | К какому времени заказ должен быть готов или доставлен (`указывается в UTC+0`)                                                             |
| comment        |     string      |            нет             | Комментарий к заказу                                                                                                                       |
| delivery       |     object      |            нет             |                                                                                                                                            |
| address        |     string      |            нет             | Адрес доставки заказа (если не указан, то данные возьмутся из карточки клиента)                                                            |

Если при первичной проверке запроса не возникло ошибок, то в ответ будет возвращён JSON-объект следующего содержания:

```json
{
  "success": true,
  "data": {
    "job_id": 54300903,
    "status": "pending"
  }
}
```

| Название |  Тип   | Описание                                                                                       |
|----------|:------:|------------------------------------------------------------------------------------------------|
| success  |  bool  | Успешность обработки задания (`true/false`)                                                    |
| data     | object | Дополнительная информация                                                                      |
| job_id   | string | ID отправленного запроса<br/>понадобится для получения статуса заказа доставки                 |
| status   | string | Текущий статус обработки запроса (может быть `pending` - ожидающий, либо `failed` - неуспешно) |

## 2. Получение статуса обработки запроса

### HTTP запрос

`GET https://{account_name}.caffesta.com/a/v1.0/draft/get_job_status/{job_id}`

Получение статуса обработки заказа происходит при обращении по пути
`/a/v1.0/draft/get_job_status/{job_id}` c использованием метода **GET** и передачей вместо `{job_id}` ID полученного
запроса из пункта 7.1

В ответ же будет возращён JSON-объект следующего содержания:

```json
{
  "success": true,
  "data": {
    "job_id": "54300903",
    "status": "success",
    "message": "fdbbdd43-9e48-4045-9432-14f44af6b8f9"
  }
}
```

| Название |  Тип   | Описание                                                                                                       |
|----------|:------:|----------------------------------------------------------------------------------------------------------------|
| success  |  bool  | Успешность обработки задания (`true/false`)                                                                    |
| data     | object | Дополнительная информация                                                                                      |
| job_id   | string | ID обрабатываемого запроса                                                                                     |
| status   | string | Текущий статус обработки запроса (может быть `pending` - ожидающий, `success` - успешно, `failed` - неуспешно) |
| message  | string | При успешности обработки возвращается UUID заказа в Caffesta, при неуспешности - причина неуспешности          |

## 3. Получение информации о заказе

### HTTP запрос

`GET https://{account_name}.caffesta.com/a/v1.0/draft/receipts/{uuid}/info`

Получение информации о заказе происходит при обращении по пути `a/v1.0/draft/receipts/{uuid}/info`
c использованием метода **GET** и передачей вместо `{uuid}` UUID чека, полученного из ответа пункта 7.2

В ответ же будет возращён JSON-объект следующего содержания:

```json
[
  {
    "id": "c1971bd4-4808-0dev-0201-702473691237",
    "terminalNumber": 2,
    "total": 90,
    "totalSum": 90,
    "discountSum": 0,
    "status": "closed"
  }
]
```

| Название       |  Тип   | Описание                   |
|----------------|:------:|----------------------------|
| id             | string | UUID заказа или чека       |
| terminalNumber |  int   | ID точки продаж            |
| total          | float  | Подытог (без учёта скидок) |
| totalSum       | float  | Итого (с учётом скидок)    |
| discountSum    | float  | Сумма скидки               |
| status         | string | Текущий статус заказа      |

Поле `status` из ответа может как значения содержать в себе следующие статусы заказа:

* wait_cashier - новый заказ;
* active - взятый в работу заказ;
* cooking - готовящийся заказ;
* cooked - приготовленный заказ;
* packed - готовый к выдаче заказ;
* closed - закрытый (т.е. уже оплаченный и отданный клиенту) заказ
* annuled - аннулированный чек (т.е. заказ оплатили и отдали клиенту, а после чек продажи был аннулирован);
* cancel - отменённый заказ (заказ отменили ещё до передачи его клиенту).

